<template>
  <div class="writing-wrapper" @click="cancelShowPanel">
    <no-ssr>
      <div class="header-wrapper">
        <el-input
          class="tit-input"
          v-model="articleTitle"
          placeholder="输入文章标题..."
        ></el-input>
        <div class="header-wrapper-right">
          <el-button class="draft" size="small">草稿箱</el-button>
          <el-button
            size="small"
            type="primary"
            @click.stop="isShowPanel = true"
            >发布</el-button
          >
          <el-avatar class="avatar" size="medium" :src="avatarUrl"></el-avatar>
        </div>
      </div>
      <div class="writing-wrapper-body">
        <mavon-editor
          ref="md"
          @imgAdd="$imgAdd"
          :boxShadow="false"
          @change="input"
          @save="input"
          class="writing-wrapper-body-editor"
          :ishljs="true"
          v-model="handbook"
        />
      </div>
      <!-- 弹窗 -->
      <PublishPanel
        @publish="publish"
        @cancel="cancelShowPanel"
        v-if="isShowPanel"
      />
    </no-ssr>
  </div>
</template>

<script>
import { Message } from "element-ui";

export default {
  layout: "fullpage",
  data() {
    return {
      handbook: "",
      articleTitle: "", // 文章标题
      avatarUrl: "",
      mdValue: "", // mavon-editor输入的内容
      rMdValue: "", // mavon-editor输入的内容解析后
      isShowPanel: false, // 是否展示弹框
      writeContent: "" // 使用正则过滤掉标签之后的文本
    };
  },
  methods: {
    cancelShowPanel() {
      // 关闭弹框
      if (!this.isShowPanel) return;
      this.isShowPanel = false;
    },
    async publish(value) {
      let description = value.description; // 文章描述

      if (!this.articleTitle) {
        Message.warning("文章标题不能为空！");
        return;
      }

      if (!this.mdValue) {
        Message.warning("文章内容不能为空！");
        return;
      }

      if (!description) {
        description = this.writeContent;
      }

      const params = {
        title: this.articleTitle,
        content: this.mdValue,
        description,
        tag: value.tag,
        titlePic: value.cover_url
      };

      const data = await this.$axios.post("/blog/create", params);

      if (data.error_code === 0) {
        Message.success("文章发表成功！");

        this.articleTitle = "";
        this.mdValue = "";
        this.handbook = "";

        this.isShowPanel = false;
      }
    },
    input(value, render) {
      this.mdValue = value;
      this.rMdValue = render;

      // 过滤解析字符串中的标签
      const reg = /<\/?.+?\/?>/g; // 过滤的正则
      const content = render.replace(reg, ""); // 使用正则替换
      this.writeContent = content.substr(0, 100);
    },
    // 绑定@imgAdd event
    $imgAdd(pos, $file) {
      // 第一步.将图片上传到服务器.
      var formdata = new FormData();
      formdata.append("image", $file);
      axios({
        url: "server url",
        method: "post",
        data: formdata,
        headers: { "Content-Type": "multipart/form-data" }
      }).then(url => {
        // 第二步.将返回的url替换到文本原位置![...](0) -> ![...](url)
        /**
         * $vm 指为mavonEditor实例，可以通过如下两种方式获取
         * 1. 通过引入对象获取: `import {mavonEditor} from ...` 等方式引入后，`$vm`为`mavonEditor`
         * 2. 通过$refs获取: html声明ref : `<mavon-editor ref=md ></mavon-editor>，`$vm`为 `this.$refs.md`
         */
        $vm.$img2Url(pos, url);
      });
    }
  }
};
</script>

<style></style>
